# Atlivu - アトライブ

AviUtl 関係の資源を再利用できないかテストしています。

<!-- AviUtl -> AVIUTL -> ATLIVU -> Atlivu -> アトライブ -> 後来歩 -->

## 事前準備

Visual Studio 2022 のランタイムライブラリが必要です。(x86・x64 両方とも)
https://docs.microsoft.com/ja-jp/cpp/windows/latest-supported-vc-redist?view=msvc-170

## 導入方法

1. 以下のファイルとフォルダを任意のフォルダに配置します。
* 任意のフォルダ
	* Atlivu.exe
	* AtlivuInput.exe
	* AtlivuOutput.exe
	* Plugins
		* lwinput.aui
		* x264guiEx.auo

Plugins フォルダは AviUtl の Plugins フォルダをそのまま持ってくれば OK。

## 使用方法

1. Atlivu.exe を起動します。

## テストの手順

1. メニューの「ファイル」→「入力プラグインを選択」で aui ファイルを選択します。(今のところ lwinput.aui のみでテスト)
1. メニューの「ファイル」→「入力プラグインの設定」で入力の設定を行います。※設定ウィンドウが背後に出ます。
1. メニューの「ファイル」→「出力プラグインを選択」で auo ファイルを選択します。(今のところ x264guiEx.auo のみでテスト)
1. メニューの「ファイル」→「出力プラグインの設定」で出力の設定を行います。※設定ウィンドウが背後に出ます。
1. メニューの「ファイル」→「メディアファイルを開く」で動画ファイルを選択します。(入力プラグインで読み込めるもの)
1. トラックーバーを動かしてシークができるかテストします。
1. 「再生」ボタンを押して再生できるかテストします。(正常動作すれば音声も出ます)
1. メニューの「ファイル」→「メディアファイルを保存」で動画ファイルを保存できるかテストします。

## 入力の流れ

Atlivu.exe (64bit UNICODE) -> AtlivuInput.exe (32bit UNICODE) -> AviUtl 入力プラグイン (32bit)<br>
プロセス間通信に WM_COPYDATA と ::ReadProcessMemory() を使用。<br>

## 出力の流れ

Atlivu.exe (64bit UNICODE) -> AtlivuOutput.exe (32bit UNICODE) -> AviUtl 出力プラグイン (32bit)<br>
プロセス間通信に名前付きパイプを使用。<br>

## シーク

* 映像を取得してビットマップを描画。
* 音声波形を取得して折れ線グラフを描画。

## 再生

* シーク処理に加えて音声を再生。WaveOut を使用。

## Direct2D

MFC がサポートしているが非常に使いづらい。OpenGL に切り替えたい。

## プロセス間通信

### WM_COPYDATA

* ::SendMessage() 限定になるので場合によっては使いにくい。

### ::ReadProcessMemory() / ::WriteProcessMemory()

* 32bit から 64bit のメモリは参照できないので使えない。
* 64bit から 32bit のメモリなら問題なく参照したり書き換えたりできるが、セキュリティソフトにウィルス扱いされそう。

### 共有メモリ

* 後から大きさを変更するのが難しい。
* 関数の引数のような小さなデータをやり取りするのには向いていない。

### 名前付きパイプ

* 使い方にクセがあるが、今のところ使用不可能な場面がなくどこでも使えそう。

## 未解決

* プラグインの設定ウィンドウが後ろに行ってしまう。
* エンコード時、音声の長さがおかしいときがある。

## 予定

* 32bit 版と 64bit 版の入出力インターフェイスを定義する。
	* 当面は 32bit 版インターフェイスで AtlivuInput.exe と AtlivuOutput.exe を使用する。
	* 入出力プラグイン製作者の方が 64bit 版インターフェイスに対応してくれたらそれを直接使用する。<br>
	これにより入出力プラグイン側のメモリ空間が 64bit に拡張され、エンコードの安定性が増す。<br>
	さらにプロセス間通信のオーバーヘッドがなくなって処理速度が多少向上する。(AviUtl と同等にまで戻る)<br>
* サブプロセスの exe ファイルはユーザーが誤って実行しないように拡張子を変えたほうがいいかもしれない。
* タイムラインの UI 制作をやってみたい。
* 描画を OpenGL にする。

## 更新履歴

* 1.0.0 - 2022/07/16 入力プラグインと出力プラグインが使えるかテスト

## 作成者情報
 
* 作成者 - 蛇色 (へびいろ)
* GitHub - https://github.com/hebiiro
* Twitter - https://twitter.com/io_hebiiro

## 免責事項

この作成物および同梱物を使用したことによって生じたすべての障害・損害・不具合等に関しては、私と私の関係者および私の所属するいかなる団体・組織とも、一切の責任を負いません。各自の責任においてご使用ください。
